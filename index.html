<!DOCTYPE HTML>
<!--
	Strata by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Strata by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="assets/css/main.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
		
		<!-- d3.js scrips -->
		<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
		<script src="node_modules/datamaps/dist/datamaps.world.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

		<link href="/assets/css/nouislider.min.css" rel="stylesheet">

		<!-- In <body> -->
		<script src="/lib/nouislider.min.js"></script>


	</head>
	<body id="top">

		<!-- Header -->
			<!--header id="header">
				<a href="#" class="image avatar"><img src="images/avatar.jpg" alt="" /></a>
				<h1><strong>I am Strata</strong>, a super simple<br />
				responsive site template freebie<br />
				crafted by <a href="http://html5up.net">HTML5 UP</a>.</h1>
			</header-->

		<!-- Main -->
			<div id="main">

				<!-- One -->
					<section id="one">
						<h2>Hämta data</h2>
						<!--div id="container" style="position: relative; width: 800px; height: 680px;"></div-->
						
						
						<!--div id ="slider-snap" style="margin-top: 20px;"></div>
						<p id="slider-snap-value-lower"></p>
						<p id="slider-snap-value-upper"></p-->

						<!--script src="\js\mapController.js"></script-->
							<select id="ddlViewBy" style="width: 200px; margin-bottom: 20px;">
							  <option value="1500">1500-1550</option>
							  <option value="1550">1550-1600</option>
							  <option value="1600">1600-1650</option>
							  <option value="1650">1650-1700</option>
							  <option value="1700">1700-1750</option>
							  <option value="1750">1750-1800</option>
							  <option value="1800">1800-1850</option>
							  <option value="1850">1850-1900</option>
							</select>
							<select id="artefakt" style="width: 200px; margin-bottom: 20px;">
							  <option value="allt">Alla</option>
							  <option value="kläder">dräkt</option>
							  <option value="möbler">möbler</option>
							  <option value="konst">konst</option>
							  <option value="tyg">tyg</option>
							  <option value="rustningar">rustningar</option>
							  <option value="vapen">vapen</option>
							</select>
							<button class="button" id="setIt">Set Specifics</button>
							<button class="button" id="getIt" disabled>Get Data</button>
							<button class="button" id="b" disabled>export to json-5t1ng1f13d</button>

						    <h1 id="demo" style="color: #52FF6B; visibility: hidden">done</h1>
						    <h1 id="demoWait" style="color: #B2163C; visibility: hidden">waiting...</h1>
						    <script type="text/javascript">

						    	var button = document.getElementById('b');
						        button.addEventListener('click', exportToJson);

						        var buttonGet = document.getElementById('getIt');
						        buttonGet.addEventListener('click', getData);

						        var buttonSet = document.getElementById('setIt');
						        buttonSet.addEventListener('click', setSpecifics);
						  		
						  		var placeArray = [];
						  		var theBigHits;
						  		var yearFrom;
								var yearTo;
								var hits; 	
								var URLen1;
								var URLen2;

						  		function setSpecifics() {

						  			var e = document.getElementById("ddlViewBy");
									var dropDownYear = e.options[e.selectedIndex].value;

									var p = document.getElementById("artefakt");
									var artefakt = p.options[p.selectedIndex].value;

									startYear = parseInt(dropDownYear);
									endYear = startYear + 50;

						  			document.getElementById("b").disabled = true;
						  			console.log(artefakt);
							  		
							  		yearFrom = startYear;
								  	yearTo = endYear;
								  	
									if (startYear == 1800 || startYear == 1850 ) {
									 	if (artefakt == "allt") {
									  		hits = 500;
									  	}
									  	else {
									  		hits = 100;
									  	}	
									}
									else if (startYear == 1750) {
									  	if (artefakt == "allt") {
									  		hits = 500;
									  	}
									  	else {
									  		hits = 100;
									  	}
									}
								  	else {
								  		hits = 100;	
								  	}

								  	if (artefakt == "allt") {
								  		URLen1 = 'http://kulturarvsdata.se/ksamsok/api?stylesheet=&x-api=lsh772&method=search&hitsPerPage='+hits+'&sort=toTime&startRecord=';
								  		URLen2 = '&query=create_toTime%3E%3D'+yearFrom+'+and+create_fromTime%3C%3D'+yearTo;
								  	}
								  	else {
								  		URLen1 = 'http://kulturarvsdata.se/ksamsok/api?stylesheet=&x-api=lsh772&method=search&hitsPerPage='+hits+'&sort=toTime&startRecord=';
								  		URLen2 =  '&query=item%3D%22'+artefakt+'%22+and+create_toTime%3E%3D'+yearFrom+'+and+create_fromTime%3C%3D'+yearTo;
								  	}
								  	
							  		$.ajax({
										    //dataType: "json",
										    url: URLen1+0+URLen2,
										    type: 'GET',
										    withCredentials: true,
										})
										.done(function(theData) {
											
											var theHits = theData.getElementsByTagName("totalHits")[0].childNodes[0].nodeValue;
											theBigHits = Math.floor(theHits/hits)*hits;
											if (theBigHits < 100) {
												hits = (theHits -1);
												theBigHits = theHits;
											}
											document.getElementById("getIt").disabled = false;


										}).fail(function(req) {	
											console.log("err");
										});
								}

								function getData() {
									console.log(hits);
									console.log(theBigHits);

									document.getElementById("b").disabled = true;
									document.getElementById("getIt").disabled = true;
									document.getElementById("demoWait").style.visibility = "visible";
									document.getElementById("demo").style.visibility = "hidden";

									console.log("yearspan: "+yearFrom+" "+yearTo);

									console.log("get");
									var counter = 0;

							  		for (var j = 0; j < theBigHits ; j = j + hits) {
							  			

								  		$.ajax({
										    //dataType: "json",
										    url: URLen1+j+URLen2,
										    type: 'GET',
										    withCredentials: true,
										})
										.done(function(testData) {

											//console.log(testData);
											
											for (var i = 0; i < hits; i++) {

												counter++;
												console.log("count"+" "+theBigHits);
												
												myCountry = testData.getElementsByTagName("countryName")[i];	
												institution = testData.getElementsByTagName("serviceOrganization")[i].childNodes[0].nodeValue;
												material = testData.getElementsByTagName("material")[i];


												if (myCountry) {
													//if (institution == 'Livrustkammaren' || institution == 'Skoklosters slott' || institution == 'Livrustkammaren') {
														
														if (containsCountry(myCountry.childNodes[0].nodeValue.toLowerCase(), placeArray) == -1) {
		
															if (material && material.childNodes[0]) {
																materialValue = material.childNodes[0].nodeValue.toLowerCase();
																placeArray.push({
																					"placeName" : myCountry.childNodes[0].nodeValue.toLowerCase(), 
																					"yearInterval" : [yearFrom, yearTo], 
																					"amount" : 1, 
																					"materialArray" : [{"material" : materialValue, "materialAmount" : 1 }]
																				});	

															}
															else {
																placeArray.push({
																					"placeName" : myCountry.childNodes[0].nodeValue.toLowerCase(), 
																					"yearInterval" : [yearFrom, yearTo], 
																					"amount" : 1, 
																					"materialArray" : []
																				});
															}
																
															 
														}
														else {
															var placeInArr = containsCountry(myCountry.childNodes[0].nodeValue.toLowerCase(), placeArray);
															placeArray[placeInArr].amount++;
															 if (material && material.childNodes[0]) {
																materialVal = material.childNodes[0].nodeValue.toLowerCase();
																if (containsMaterial(materialVal, placeArray[placeInArr].materialArray) == -1) {

																	placeArray[placeInArr].materialArray.push({"material" : materialVal, "materialAmount" : 1 });
																}
																else {
																	placeArray[placeInArr].materialArray[containsMaterial(materialVal, placeArray[placeInArr].materialArray)].materialAmount++;
																}

															} 
														}
													//}	
												}
												if (counter == theBigHits) {
													document.getElementById("demoWait").style.visibility = "hidden"; 
													document.getElementById("demo").style.visibility = "visible";
													document.getElementById("b").disabled = false;
													document.getElementById("getIt").disabled = false;
												}
											 
											};

											


										}).fail(function(req) {	
											alert("err, refresh and try again");
										});

										
									};
								}

						        function exportToJson() {
						            console.log(placeArray);
						            window.open('data:text/csv;charset=utf-8,' + escape(JSON.stringify(placeArray)));
						        }

						        

						        function containsCountry(obj, list) {
								    var i;
								    for (i = 0; i < list.length; i++) {
								        if (list[i].placeName === obj) {
								            return i;
								        }
								    }

								    return -1;
								}

								function containsMaterial(obj, list) {
								    var i;
								    for (i = 0; i < list.length; i++) {
								        if (list[i].material === obj) {
								            return i;
								        }
								    }

								    return -1;
								}


						    </script>
						
					</section>

				<!-- Two -->
					<section id="two">
						<h2>Hur gör man?</h2>
						<p>Ingen proxy-server är skapad så för att kunna göra GET-request måste man ladda ner ett plugin till chrome som heter <i>Allow-Control-Allow-Origin. </i>   Aktivera sedan det när du ska hämta din data.</p>
						<p>Välj först vilket tidsintervall och vilken artefaktgrupp du vill ha din data ifrån. Klicka sedan <i>set specifics</i>. Därefter klickar du på <i>get data </i> och väntar. Datamängden är mycket stor så det kan ta VÄLDIGT lång tid, ta en kopp kaffe. När det är färdigt står det done. Klicka då på <i>export to json-5t1ng1f13d</i>. Tyvärr exporteras faktiskt inte en json array utan en .txt-fil, man får själv göra om den till json. <strong style="color: #B2163C;">Glöm inte att "refresha'a" sidan innna du ska hämta ny data om du inte vill att allt ska bli helt fel!</strong> </p>
						<p>TIPS: Genom att kolla i consollen för webläsaren så kan man få sig en idé om hur långt det har laddat eller om det har blivit något error.</p>
					</section>

				

			</div>


			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.poptrox.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			<script src="assets/js/main.js"></script>

	</body>
</html>